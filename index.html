<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="applicable-device" content="mobile" />
    <meta name="referrer" content="always" />
    <meta
      name="viewport"
      content="width=device-width, height=device-height, user-scalable=no, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"
    />
    <title>不靠谱医院活动</title>
    <link rel="stylesheet" type="text/css" href="./reset.css" />
    <link rel="stylesheet" type="text/css" href="./index.css" />
    <script src="./js/data.js"></script>
    <!-- html2canvas将Dom节点在Canvas里边画出来 -->
    <script src="./js/html2canvas.min.js"></script>
    <!-- 将canvas图片保存成图片 -->
    <script src="./js/canvas2image.js"></script>
    <script src="./js/base64.js"></script>
  </head>
  <body>
    <div id="app">
      <!-- 第一页 -->
      <div class="first-page">
        <input
          type="text"
          placeholder="请输入您的姓名"
          class="first-page-input"
        />
        <img
          src="./images/button.png"
          alt=""
          class="first-page-button"
          onclick="toInsure()"
        />
      </div>
      <div class="second-page">
        <p class="second-page-title"></p>
        <div class="second-page-content">
          <img src="" class="content-img" /> <span class="content-tip"></span>
        </div>
        <div class="second-page-content">
          <img src="" class="content-img" /> <span class="content-tip"></span>
        </div>
        <div class="second-page-content">
          <img src="" class="content-img" /> <span class="content-tip"></span>
        </div>
        <div class="second-page-content">
          <img src="" class="content-img" /> <span class="content-tip"></span>
        </div>
      </div>
      <div class="three-page">
        <svg
          style="width:100%;height:100%;"
          xmlns="http://www.w3.org/2000/svg"
          id="mySVG"
          viewBox="0 0 100% 100%"
          preserveAspectRatio="xMidYMid meet"
        >
          <image
            xlink:href="./images/sun.png"
            x="7%"
            y="5%"
            display="block"
            width="86%"
            height="50"
          >
            <animate
              attributeName="y"
              values="5%;70%;5%"
              begin="0s"
              dur="2s"
              repeatCount="indefinite"
            />
          </image>
        </svg>
      </div>
      <img src="" id="img" />
      <div class="four-page">
        <p class="four-page-title">春节假期综合症专科诊疗医院</p>
        <p class="four-page-title-second">诊断证明书</p>
        <div class="four-page-customer">
          <span class="customer-item-name">姓名</span>
          <span class="customer-item-department">科别：变态反应科</span>
          <span class="customer-item-clinic">门诊诊断</span>
        </div>
        <div class="four-page-result">
          <p>诊断及建议</p>
          <p>
            间歇性情绪不稳定；眼球不定时上翻难以控制，主要表现在不愿确认眼神，怼天怼地怼空气，一不小心就爆炸。
          </p>
          <p class="four-page-result-text">
            建议休息一周，以食物修身养性，避免影响节后工作。
          </p>
        </div>
        <div class="four-page-sign">
          <div class="four-page-sign-left">
            <img src="./images/qr_code.jpg" class="four-page-sign-left-img" />
          </div>
          <div class="four-page-sign-right">
            <p class="four-page-sign-date">日期：</p>
            <p>医师：Dr.Kaopu</p>
            <p>
              <img src="./images/stamp.png" class="four-page-sign-right-img" />
            </p>
          </div>
        </div>
      </div>
      <div class="four-page-content-img">
        <img src="./images/clip.png" class="four-page-clip" />
        <img src="./images/left_hand.png" class="four-page-left-hand" />
        <img src="./images/right_hand.png" class="four-page-right-hand" />
      </div>
      <div class="hand-move">
        <img src="./images/hand_move.png" alt="" class="hand-move-img" />
      </div>
    </div>

    <!-- <div class="hand-move">
<img src="./images/hand_move.png" class="hand-move-img">
      </div>
    </div> -->
    <script>
      // 点击立即诊断
      var app = document.getElementById("app");
      var firstPage = document.getElementsByClassName("first-page")[0];
      var secondPage = document.getElementsByClassName("second-page")[0];
      var threePage = document.getElementsByClassName("three-page")[0];
      var fourPage = document.getElementsByClassName("four-page")[0];
      var handMove = document.getElementsByClassName("hand-move")[0];
      var handMoveImg = document.getElementsByClassName("hand-move-img")[0];
      var fourPageImg = document.getElementsByClassName(
        "four-page-content-img"
      )[0];
      var firstPageInput = document.getElementsByClassName(
        "first-page-input"
      )[0];
      var secondPageTitle = document.getElementsByClassName(
        "second-page-title"
      )[0];
      var secondPageContents = document.getElementsByClassName(
        "second-page-content"
      );
      // var pageNum = 0 || sessionStorage.getItem("pageNum");
      var pageNum = 0; //当前是第几题
      var nameValue = null; //用户输入的名称
      function toInsure() {
        nameValue = firstPageInput.value;
        //判断是否已经输入了值
        if (!nameValue) {
          alert("请输入您的姓名");
        } else {
          //点击立即诊断，换背景图片隐藏首页的内容
          app.style.backgroundImage = "url('./images/background2.jpg')";
          firstPage.style.display = "none";
          secondPage.style.display = "block";
          sessionStorage.setItem("pageNum", pageNum);
          sessionStorage.setItem("nameValue", nameValue);
        }
        this.operateOption(pageNum);
      }
      //根据第几题展示内容
      function operateOption(num) {
        var that = this;
        var option = questionData.find(item => {
          return item.order == num;
        });
        var isUnNormal = false; //是否选择了关你屁事
        secondPageTitle.innerHTML = option.title;
        option.options.forEach((item, index) => {
          var parentNode = secondPageContents[index];
          parentNode.children[1].innerHTML = item.value;
          parentNode.children[0].setAttribute("src", "./images/radio.png");
        });
        if (option.options.length < 4) {
          var parentNode = secondPageContents[3];
          parentNode.children[1].innerHTML = "";
          parentNode.children[0].setAttribute("src", "");
        }
        for (var i = 0; i < secondPageContents.length; i++) {
          let childValue = secondPageContents[i].children[1].innerText;
          if (childValue) {
            (function(i) {
              secondPageContents[i].onclick = function() {
                secondPageContents[i].children[0].setAttribute(
                  "src",
                  "./images/radio_checked.png"
                );
                if (num == "0") {
                  pageNum += 1;
                } else if (num == "1") {
                  // merrageCode = i;
                  //第二题判断是选择的那一道题
                  if (i == "0") {
                    pageNum = 8;
                    //选择已婚
                  } else if (i == "1" || i == "2") {
                    pageNum = 3;
                  } else {
                    //选择了管你屁事
                    isUnNormal = true;
                    that.dealNoCare();
                  }
                } else if (num == 8) {
                  if (i == "0") {
                    pageNum = 4;
                  } else if (i == "1") {
                    pageNum = 2;
                  } else {
                    //选择了管你屁事
                    isUnNormal = true;
                    that.dealNoCare();
                  }
                } else if (num == 4) {
                  if (i == 2) {
                    //选择了管你屁事
                    isUnNormal = true;
                    that.dealNoCare();
                  } else {
                    pageNum = 2;
                  }
                } else if (num == 2) {
                  if (i == 2) {
                    //选择了管你屁事
                    isUnNormal = true;
                    that.dealNoCare();
                  } else {
                    pageNum = 5;
                  }
                } else if (num == 3) {
                  if (i == 0) {
                    pageNum = 6;
                  } else if (i == 1 || i == 2) {
                    pageNum = 5;
                  }
                } else if (num == 6) {
                  if (i == 2) {
                    //选择了管你屁事
                    isUnNormal = true;
                    that.dealNoCare();
                  } else {
                    pageNum = 7;
                  }
                } else if (num == 7) {
                  pageNum = 5;
                } else if (num == 5) {
                  //最后一题进入loading页面
                  that.dealResult();
                }
                if (num != 5 && !isUnNormal) {
                  setTimeout(function() {
                    return operateOption(pageNum);
                  }, 500);
                }
              };
            })(i);
          }
        }
      }
      //处理关你屁事的选项
      function dealNoCare() {
        handMove.style.display = "block";
        handMoveImg.style.animation = "mymove 0.5s forwards";
        setTimeout(function() {
          this.dealResult();
        }, 2000);
      }
      //最后结果页
      function dealResult() {
        handMove.style.display = "none";
        var customerName = document.getElementsByClassName(
          "customer-item-name"
        )[0];
        var signDate = document.getElementsByClassName(
          "four-page-sign-date"
        )[0];
        // // 首先进入loading页面
        app.style.backgroundImage = "url('./images/background3.jpg')";
        secondPage.style.display = "none";
        threePage.style.display = "block";
        // //此时把结果页生成图片
        // customerName.innerHTML = "姓名：" + nameValue;
        // signDate.innerHTML = "日期：" + this.getNowDate();

        //loading页面显示2秒后进入结果页面
        setTimeout(function() {
          app.style.backgroundImage = "url('./images/background4.jpg')";
          threePage.style.display = "none";
          fourPage.style.display = "block";
          customerName.innerHTML = "姓名：" + nameValue;
          signDate.innerHTML = "日期：" + this.getNowDate();
          fourPageImg.style.display = "block";
          this.html2Canvas();
          //loading页面显示2秒后进入结果页面
          // this.getCanvasImg();
          // 进行canvas生成图片
          // html2canvas(fourPage, {
          //   onrendered: function(canvas) {
          //     //添加属性
          //     canvas.setAttribute("id", "thecanvas");
          //     //读取属性值
          //     // var value= canvas.getAttribute('id');
          //     fourPage.innerHTML = "";
          //     fourPage.appendChild(canvas);
          //     var thecanvas = document.getElementById("thecanvas");
          //     var imgUrl = thecanvas.toDataURL("image/png");
          //     var img = document.getElementById("img");
          //     fourPage.style.display = "none";
          //     img.style.display = "block";
          //     img.src = imgUrl;
          //   }
          // });
        }, 3000);
        // setTimeout(function() {
        //   this.html2Canvas();
        // }, 4000);
      }

      function html2Canvas() {
        const shareContent = fourPage; // 需要绘制的部分的 (原生）dom 对象 ，注意容器的宽度不要使用百分比，使用固定宽度，避免缩放问题
        const width = shareContent.offsetWidth; // 获取(原生）dom 宽度
        const height = shareContent.offsetHeight; // 获取(原生）dom 高
        const offsetTop = shareContent.offsetTop; // 元素距离顶部的偏移量
        const canvas = document.createElement("canvas"); // 创建canvas 对象
        const context = canvas.getContext("2d");
        const scaleBy = getPixelRatio(context); // 获取像素密度的方法 (也可以采用自定义缩放比例)
        canvas.width = width * scaleBy; // 这里 由于绘制的dom 为固定宽度，居中，所以没有偏移
        canvas.height = (height + offsetTop) * scaleBy; // 注意高度问题，由于顶部有个距离所以要加上顶部的距离，解决图像高度偏移问题
        context.scale(scaleBy, scaleBy);
        const opts = {
          // allowTaint: true, // 允许加载跨域的图片 （使用这个会报错）
          useCORS: true, // 允许加载跨域图片
          tainttest: true, // 检测每张图片都已经加载完成
          scale: scaleBy, // 添加的scale 参数
          canvas: canvas, // 自定义 canvas
          // logging: true, // 日志开关，发布的时候记得改成false
          width: width, // dom 原始宽度
          height: height // dom 原始高度
        };
        html2canvas(shareContent, opts).then(function(canvas) {
          var context = canvas.getContext("2d");
          // 【重要】关闭抗锯齿
          context.mozImageSmoothingEnabled = false;
          context.webkitImageSmoothingEnabled = false;
          context.msImageSmoothingEnabled = false;
          context.imageSmoothingEnabled = false;
          //添加属性
          canvas.setAttribute("id", "thecanvas");
          fourPage.innerHTML = "";
          fourPage.appendChild(canvas);
          var thecanvas = document.getElementById("thecanvas");
          var imgUrl = thecanvas.toDataURL("image/png");
          var img = document.getElementById("img");
          fourPage.style.display = "none";
          img.style.display = "block";
          img.src = imgUrl;
          //  const _src = canvas.toDataURL();
          //  var img = document.getElementById("img");
          // //  const img = document.createElement('img')
          //  img.id = 'shareImgCanvas'
          //  img.src = _src
          //  img.style.cssText = 'width: 100%;'
          //  console.log('html2canvas')
        });
      }
      function getPixelRatio(context) {
        // 获取设备的pixel ratio
        const backingStore =
          context.backingStorePixelRatio ||
          context.webkitBackingStorePixelRatio ||
          context.mozBackingStorePixelRatio ||
          context.msBackingStorePixelRatio ||
          context.oBackingStorePixelRatio ||
          context.backingStorePixelRatio ||
          1;
        return (window.devicePixelRatio || 1) / backingStore;
      }

      function getNowDate() {
        var now = new Date();
        var year = now.getFullYear(); //年
        var month = now.getMonth() + 1; //月
        var day = now.getDate(); //日
        var clock = year + "年";
        if (month < 10) {
          clock += "0";
        }
        clock += month + "月";
        if (day < 10) {
          clock += "0";
        }
        clock += day + "日";
        return clock;
      }
    </script>
  </body>
</html>
